---
- name: Play1 - Configure LAN Switches
  hosts: lan
  gather_facts: yes
  tags: lan
  tasks:
  - name: Configure Hostname and Domain Name
    cisco.ios.ios_system:
      hostname: "{{ inventory_hostname }}"
      domain_name: "{{ domain_name }}"
      lookup_enabled: no
      name_servers: "{{ dns_servers }}"

  - name: Configure NTP
    cisco.ios.ios_ntp:
      server: "{{ ntp_server }}"
      logging: true
      state: present
      key_id: "10"
      auth_key: 15435A030726242723273C21181319000A
      auth: true

  - name: Get Running Config
    cisco.ios.ios_command:
      commands:
      - sh run
    register: running_config
  
  - name: Get Current List of NTP Servers
    set_fact: ntp_servers_in_cfg="{{ running_config.stdout[0] | regex_findall('^ntp server (\S+)', multiline=True) }}"

  - name: Remove Old NTP Servers
    cisco.ios.ios_config:
      lines:
      - "no ntp server {{ item }}"
    when: item != ntp_server
    loop: "{{ ntp_servers_in_cfg }}"

  - name: Configure Interfaces
    cisco.ios.ios_interfaces:
      config:
      - name: "{{ item.name }}"
        description: "{{ item.description }}"
        duplex: "{{ intf_duplex }}"
        mtu: "{{ intf_mtu }}"
      state: merged
    loop: "{{ l2_interfaces[inventory_hostname] }}"
    register: ios_intf
    tags: interfaces

  - name: Display Interfaces
    debug: item
    when: "'description' in item"
    loop: "{{ ios_intf.results[0].after }}"
    tags: interfaces

  - name: Configure L2 VLANs in DB
    cisco.ios.ios_vlans:
      config:
      - name: "{{ item.name }}"
        vlan_id: "{{ item.vlan_id }}"
        state: active
      state: merged
    loop: "{{ vlans }}"
    register: vlans
    tags: vlans
  
  - name: Display L2 VLANs
    debug: var=vlans

  


